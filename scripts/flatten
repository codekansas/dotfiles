#!/bin/sh
# Moves a directory's contents up one level and deletes the directory.

if [ $# -ne 1 ]; then
    echo "Usage: flatten <directory>"
    exit 1
fi

if [ ! -d "$1" ]; then
    echo "Error: $1 is not a directory"
    exit 1
fi

# Moves the directory to a temporary location.
tmpdir=$(mktemp -d)
fromdir=$tmpdir/$(basename "$1")
mv "$1" "$fromdir"
todir=$(dirname "$1")

# Shows progress for file moves.
total=$(find "$fromdir" -maxdepth 1 -mindepth 1 | wc -l | tr -d " ")
moved=0

print_progress() {
    if [ "$total" -eq 0 ]; then
        return
    fi
    pct=$((moved * 100 / total))
    filled=$((pct / 2))
    bar=$(printf "%${filled}s" "" | tr " " "#")
    empty=$(printf "%$((50 - filled))s" "" | tr " " "-")
    printf "\r[%s%s] %d/%d" "$bar" "$empty" "$moved" "$total"
}

# Moves regular and hidden files.
for file in "$fromdir"/* "$fromdir"/.*; do
    if [ "$file" = "$fromdir/." ] || [ "$file" = "$fromdir/.." ]; then
        continue
    fi
    if [ ! -e "$file" ]; then
        continue
    fi
    mv "$file" "$todir"
    moved=$((moved + 1))
    print_progress
done
if [ "$total" -gt 0 ]; then
    printf "\n"
fi

# Removes the temporary directory.
rmdir "$fromdir"
